<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IslamGPT - رؤية جديدة متكاملة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            
            /* Enhanced Modern Dusk Theme (Default) */
            --bg-main: #101214;
            --bg-main-gradient: linear-gradient(135deg, #161a1d 0%, #101214 100%);
            --bg-surface: #1f2428;
            --bg-surface-hover: #2c3136;
            --bg-header: rgba(31, 36, 40, 0.85); /* Slightly transparent for depth */
            
            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --text-placeholder: #787a7e;

            --accent-primary: #9b59b6; /* A richer purple */
            --accent-primary-hover: #8e44ad;
            --accent-secondary: #1abc9c; /* A vibrant teal/green */
            --accent-secondary-hover: #16a085;

            --user-message-bg: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-hover));
            --user-message-text: #ffffff;
            --bot-message-bg: var(--bg-surface-hover);
            --bot-message-text: var(--text-primary);
            
            --border-color: #3a3f44;
            --scrollbar-thumb: #4a4f54;
            --scrollbar-track: var(--bg-surface);

            --error-bg: #c0392b;
            --error-text: #ffffff;

            --overlay-bg: rgba(0, 0, 0, 0.75);
            --shadow-color: rgba(0, 0, 0, 0.4);

            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 16px;

            --transition-speed: 0.3s;
            --message-font-base-size: 0.95rem;
        }

        /* Enhanced Light Theme Variables */
        :root.light-theme {
            --bg-main: #e9ebee;
            --bg-main-gradient: linear-gradient(135deg, #f0f2f5 0%, #e9ebee 100%);
            --bg-surface: #ffffff;
            --bg-surface-hover: #f8f9fa;
            --bg-header: rgba(255, 255, 255, 0.85);
            
            --text-primary: #1d2129;
            --text-secondary: #495057;
            --text-placeholder: #6c757d;

            --accent-primary: #8e44ad;
            --accent-primary-hover: #9b59b6;
            --accent-secondary: #16a085;
            --accent-secondary-hover: #1abc9c;

            --user-message-bg: linear-gradient(135deg, #007bff, #0056b3); 
            --user-message-text: #ffffff;
            --bot-message-bg: #e9ecef;
            --bot-message-text: #212529;
            
            --border-color: #dee2e6;
            --scrollbar-thumb: #adb5bd;
            --scrollbar-track: #e9ecef;

            --error-bg: #f8d7da;
            --error-text: #721c24;
            --overlay-bg: rgba(200, 200, 200, 0.6);
            --shadow-color: rgba(0, 0, 0, 0.15);
        }

        /* Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body {
            font-family: var(--font-family);
            background: var(--bg-main-gradient);
            background-size: 200% 200%;
            animation: backgroundPan 30s ease infinite;
            color: var(--text-primary); 
            display: flex; 
            align-items: center;
            justify-content: center; 
            min-height: 100vh; 
            overflow: hidden;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        @keyframes backgroundPan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* App Layout */
        .app-container {
            display: flex; 
            width: 100%; 
            max-width: 1200px;
            height: 100vh; 
            max-height: 95vh; 
            background: var(--bg-surface);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 15px 50px var(--shadow-color);
            overflow: hidden; 
            position: relative;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed);
        }

        /* Sidebar */
        .sidebar {
            width: 320px; 
            background: var(--bg-main); 
            color: var(--text-primary);
            display: flex; 
            flex-direction: column;
            border-left: 1px solid var(--border-color); /* RTL */
            flex-shrink: 0; 
            transition: transform var(--transition-speed) ease-in-out, background-color var(--transition-speed), border-color var(--transition-speed);
            z-index: 100;
        }
        .sidebar-header {
            padding: 20px 15px; 
            text-align: center;
            border-bottom: 1px solid var(--border-color); 
            flex-shrink: 0;
            transition: border-color var(--transition-speed);
        }
        .sidebar-header h2 { font-size: 1.5em; margin-bottom: 8px; color: var(--accent-primary); }
        .sidebar-header p { font-size: 0.85em; color: var(--text-secondary); }

        #newChatBtn, .sidebar-footer-btn {
            display: flex; 
            align-items: center; 
            justify-content: center;
            width: calc(100% - 30px); 
            margin: 15px auto; 
            padding: 12px 18px;
            color: var(--user-message-text); 
            border: none;
            border-radius: var(--border-radius-md); 
            cursor: pointer;
            font-size: 1em; 
            font-weight: 500;
            transition: background-color var(--transition-speed) ease, background-image var(--transition-speed) ease, transform 0.2s ease; 
            flex-shrink: 0;
        }
        #newChatBtn {
            background: var(--accent-primary);
            background-image: linear-gradient(45deg, var(--accent-primary), var(--accent-primary-hover));
        }
        #newChatBtn:hover { transform: translateY(-2px); background-image: linear-gradient(45deg, var(--accent-primary-hover), var(--accent-primary)); }
        #newChatBtn i { margin-left: 10px; font-size: 1.1em; }

        .sidebar-footer-btn {
            margin-bottom: 20px; 
            background: var(--bg-surface-hover);
            color: var(--text-secondary); 
            border: 1px solid var(--border-color); 
            text-align: center;
            font-size: 0.9em;
        }
        .sidebar-footer-btn:hover { background: var(--accent-secondary); color: white; transform: translateY(-2px); }
        .sidebar-footer-btn i { margin-left: 8px; }

        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-list-item {
            padding: 12px 15px; 
            margin-bottom: 10px;
            border-radius: var(--border-radius-md); 
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background-color: var(--bg-surface); 
            border: 1px solid transparent;
        }
        .chat-list-item:hover { background-color: var(--bg-surface-hover); transform: translateX(-5px); }
        .chat-list-item.active {
            background-color: var(--accent-primary); 
            color: var(--user-message-text);
            font-weight: 600; 
            border-color: var(--accent-primary-hover); 
            transform: translateX(0);
        }
        .chat-list-item span {
            flex-grow: 1; 
            overflow: hidden; 
            text-overflow: ellipsis;
            white-space: nowrap; 
            margin-left: 10px;
        }
        .delete-chat-btn {
            background: none; 
            border: none; 
            color: var(--text-secondary);
            cursor: pointer; 
            font-size: 0.95em; 
            padding: 5px;
            opacity: 0; 
            transition: opacity var(--transition-speed) ease, color var(--transition-speed) ease;
            flex-shrink: 0; 
            transform: translateX(10px);
        }
        .chat-list-item:hover .delete-chat-btn { opacity: 0.6; transform: translateX(0); }
        .delete-chat-btn:hover { opacity: 1; color: var(--error-text); }

        /* Chat Area */
        .chat-area {
            flex: 1; 
            display: flex; 
            flex-direction: column;
            background: var(--bg-surface); 
            overflow: hidden;
            transition: background-color var(--transition-speed);
        }
        .header {
            background: var(--bg-header); 
            color: var(--text-primary);
            padding: 15px 20px; 
            display: flex; 
            align-items: center;
            justify-content: space-between; 
            position: relative;
            border-bottom: 1px solid var(--border-color); 
            flex-shrink: 0;
            transition: all var(--transition-speed);
            backdrop-filter: blur(10px);
        }
        #menuToggleBtn {
            background: none; 
            border: none; 
            color: var(--text-primary);
            font-size: 1.5em; 
            cursor: pointer; 
            padding: 5px; 
            display: none;
        }
        .header-content h1 { font-size: 1.3em; margin-bottom: 2px; }
        .header-content p { font-size: 0.8em; color: var(--text-secondary); }
        
        .header-actions { display: flex; align-items: center; gap: 5px; }
        .header-actions button {
            background: none; 
            border: none; 
            color: var(--text-secondary);
            font-size: 1.2em; 
            padding: 8px; 
            cursor: pointer;
            border-radius: 50%; 
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }
        .header-actions button:hover { background-color: var(--bg-surface-hover); color: var(--text-primary); }

        /* Messages */
        .messages {
            flex: 1; 
            padding: 20px; 
            overflow-y: auto;
            position: relative; 
            scroll-behavior: smooth;
        }
        .message {
            margin-bottom: 20px; 
            padding: 14px 20px;
            border-radius: var(--border-radius-lg);
            max-width: 80%; 
            line-height: 1.7;
            position: relative; 
            opacity: 0;
            animation: fadeInMessage 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
            font-size: var(--message-font-base-size);
            transition: all var(--transition-speed);
        }
        .message.animate-new { transform: translateY(20px); }
        @keyframes fadeInMessage { to { opacity: 1; transform: translateY(0); } }

        .message-actions {
            position: absolute; 
            top: 50%; 
            transform: translateY(-50%);
            display: flex; 
            gap: 5px;
            opacity: 0; 
            transition: all var(--transition-speed);
        }
        .message:hover .message-actions { opacity: 1; }
        .user-message .message-actions { right: -45px; /* RTL: left */ }
        .bot-message .message-actions { left: -45px; /* RTL: right */ }

        .copy-message-btn, .pin-message-btn, .tts-message-btn {
            background: var(--bg-surface); 
            border: 1px solid var(--border-color);
            color: var(--text-secondary); 
            width: 32px; 
            height: 32px; 
            font-size: 0.9em;
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-radius: 50%; 
            transition: all var(--transition-speed);
        }
        .copy-message-btn:hover, .pin-message-btn:hover, .tts-message-btn:hover { background: var(--accent-secondary); color: white; border-color: var(--accent-secondary); transform: scale(1.1); }
        .tts-message-btn.loading i { animation: fa-spin 1s infinite linear; }
        .tts-message-btn.playing { color: var(--accent-secondary); border-color: var(--accent-secondary); animation: pulse-green 1.5s infinite; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(26, 188, 156, 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(26, 188, 156, 0); }
            100% { box-shadow: 0 0 0 0 rgba(26, 188, 156, 0); }
        }

        .user-message { background: var(--user-message-bg); color: var(--user-message-text); margin-left: auto; text-align: right; border-bottom-right-radius: var(--border-radius-sm); }
        .bot-message { background: var(--bot-message-bg); color: var(--bot-message-text); margin-right: auto; border-bottom-left-radius: var(--border-radius-sm); border: 1px solid var(--border-color); }

        /* Input Area */
        .input-area {
            display: flex; 
            padding: 15px; 
            background: var(--bg-main);
            border-top: 1px solid var(--border-color);
            gap: 12px; 
            align-items: flex-end; 
            flex-shrink: 0;
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
            position: relative;
        }
        #messageInput { 
            flex: 1; 
            padding: 14px 18px; 
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius-md); 
            outline: none; 
            font-size: 1rem; 
            resize: none; 
            min-height: 50px; 
            max-height: 120px; 
            font-family: inherit; 
            line-height: 1.5; 
            background-color: var(--bg-surface); 
            color: var(--text-primary); 
            transition: all var(--transition-speed); 
        }
        #messageInput:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-primary) 30%, transparent); }
        
        #recordBtn, #sendBtn {
            background: var(--bg-surface-hover); 
            color: var(--text-primary); 
            border: 1px solid var(--border-color);
            width: 50px; height: 50px; 
            font-size: 1.2rem;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all var(--transition-speed);
            flex-shrink: 0;
        }
        #sendBtn {
             background: var(--accent-secondary); color: white; border: none;
        }
        #sendBtn:hover { transform: scale(1.05); }
        #sendBtn:disabled { background: #50555a; color: #8e9092; cursor: not-allowed; transform: scale(1); }
        #recordBtn:hover { background-color: var(--bg-surface); transform: scale(1.05); }
        #recordBtn.recording {
            background-color: #c0392b; color: white; border-color: #c0392b;
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); }
            100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); }
        }
        
        /* Utility & Other Components */
        .welcome-area, .no-chat-selected {
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            height:100%; text-align:center; color:var(--text-secondary); padding:20px;
        }
        .welcome-area i, .no-chat-selected i { font-size:3.5em; margin-bottom:20px; color:var(--accent-primary); }
        .welcome-area h3, .no-chat-selected h3 { color:var(--text-primary); margin-bottom:12px; font-size:1.5em; }

        #scrollToBottomBtn{
            position:absolute; bottom:20px; right:20px; background-color:var(--accent-secondary); color:white;
            border:none; border-radius:50%; width:45px; height:45px; font-size:1.2em; cursor:pointer;
            display:none; align-items:center; justify-content:center; box-shadow:0 2px 10px var(--shadow-color);
            z-index:10; opacity:0; transform:translateY(10px); transition: opacity 0.3s, transform 0.3s;
        }
        #scrollToBottomBtn.visible{ display:flex; opacity:1; transform:translateY(0); }
        #scrollToBottomBtn:hover{ background-color:var(--accent-secondary-hover); }

        .visually-hidden{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

        /* Scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        .chat-list::-webkit-scrollbar { width: 6px; }

        /* All other minor styles from original file */
        .islamic-reminder{font-size:.8em;color:var(--text-secondary);padding:10px;margin-top:10px;border-top:1px dashed var(--border-color);border-bottom:1px dashed var(--border-color);text-align:center;min-height:30px;transition:color var(--transition-speed),border-color var(--transition-speed)}.chat-list-item.renaming{border-color:var(--accent-secondary);box-shadow:0 0 5px var(--accent-secondary)}.chat-list-item.active .delete-chat-btn{color:var(--user-message-text);opacity:.8}.chat-list-item.active .delete-chat-btn:hover{opacity:1}.header-content h1 .fa-mosque{margin-left:10px;color:var(--accent-secondary)}.dropdown-content{display:none;position:absolute;left:0;top:100%;background-color:var(--bg-main);min-width:200px;box-shadow:0 8px 16px 0 var(--shadow-color);z-index:10;border-radius:var(--border-radius-md);border:1px solid var(--border-color);padding:5px 0}.dropdown-content button{color:var(--text-primary);padding:10px 15px;text-decoration:none;display:block;width:100%;text-align:right;font-size:.9em;border:none;background:none;cursor:pointer}.dropdown-content button:hover{background-color:var(--bg-surface-hover)}.chat-options-dropdown.open .dropdown-content{display:block}#botStatus{font-size:.75em;color:var(--accent-secondary);opacity:0;min-width:80px;text-align:left;transition:opacity .3s}#botStatus.visible{opacity:1}.search-bar-container{padding:10px 15px;background-color:var(--bg-main);border-bottom:1px solid var(--border-color);display:none;gap:10px;align-items:center}.search-bar-container.visible{display:flex}#chatSearchInput{flex-grow:1;padding:8px 12px;background-color:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border-color);border-radius:var(--border-radius-md);font-size:.9em}#clearSearchBtn{background:none;border:none;color:var(--text-secondary);font-size:1.2em;cursor:pointer}.quick-prompts-container{padding:15px;text-align:center}.quick-prompts-container h4{font-size:.9em;color:var(--text-secondary);margin-bottom:10px}.quick-prompt-btn{background-color:var(--bg-surface-hover);color:var(--text-primary);border:1px solid var(--border-color);padding:8px 12px;margin:5px;border-radius:var(--border-radius-md);cursor:pointer;font-size:.85em}.quick-prompt-btn:hover{background-color:var(--accent-secondary);color:white}mark{background-color:var(--accent-secondary);color:white;padding:.1em .2em;border-radius:var(--border-radius-sm)}.error{background:var(--error-bg)!important;color:var(--error-text)!important;border-color:transparent!important}.mobile-overlay{display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:var(--overlay-bg);z-index:50;opacity:0;transition:opacity .3s}.mobile-overlay.active{display:block;opacity:1}.modal-container,.custom-modal-container{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:var(--overlay-bg);justify-content:center;align-items:center;z-index:200;opacity:0;backdrop-filter:blur(5px);transition:opacity .3s}.modal-container.visible,.custom-modal-container.visible{display:flex;opacity:1}.modal-content,.custom-modal-content{background-color:var(--bg-surface);padding:25px 30px;border-radius:var(--border-radius-lg);box-shadow:0 5px 20px var(--shadow-color);width:90%;max-width:450px;position:relative;color:var(--text-primary);transform:scale(.95);transition:transform .3s}.modal-container.visible .modal-content,.custom-modal-container.visible .custom-modal-content{transform:scale(1)}.custom-modal-content p{margin:20px 0;font-size:1.1em;line-height:1.6}.custom-modal-buttons{display:flex;justify-content:center;gap:15px;margin-top:20px}.custom-modal-buttons button{padding:10px 25px;border-radius:var(--border-radius-md);border:none;font-size:1em;cursor:pointer;transition:transform .2s,background-color var(--transition-speed)}.custom-modal-buttons button:hover{transform:translateY(-2px)}#confirmModalBtn{background-color:var(--error-bg);color:var(--error-text)}#cancelModalBtn{background-color:var(--bg-surface-hover);color:var(--text-primary);border:1px solid var(--border-color)}.modal-close-btn{position:absolute;top:10px;right:15px;background:none;border:none;font-size:1.8em;color:var(--text-secondary);cursor:pointer}.setting-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid var(--border-color);font-size:1em}.setting-item:last-child{border-bottom:none;margin-bottom:0}

        /* --- RESPONSIVE STYLES --- */
        
        /* For Smart TV / Large Desktops */
        @media (min-width: 1600px) {
            html {
                font-size: 18px; /* Increase base font size for better readability from a distance */
            }
            .app-container {
                max-width: 1400px; /* Allow content to use a bit more space */
                max-height: 90vh;
            }
        }

        /* For Tablets and smaller desktops */
        @media (max-width: 900px) {
            .app-container {
                flex-direction: column; /* Stack sidebar and chat area vertically */
                max-height: 100vh;
                height: 100vh;
                border-radius: 0;
            }
            .sidebar {
                width: 100%;
                max-height: 50vh; /* Limit sidebar height */
                position: relative;
                transform: translateX(0) !important;
                box-shadow: none;
                border-left: none;
                border-bottom: 1px solid var(--border-color); /* Add border between sidebar and chat */
            }
            .chat-area {
                flex: 1;
                height: 100%; /* Ensure it fills remaining space */
            }
            .message {
                max-width: 90%;
            }
            /* Make message actions visible by default on touch devices */
            .message-actions {
                position: static;
                margin-top: 10px;
                justify-content: flex-end;
                transform: none;
                opacity: 1;
                display: flex;
                gap: 8px;
            }
            .message-actions button {
                width: 40px;
                height: 40px;
                font-size: 1em;
            }
            #menuToggleBtn {
                display: none; /* Hide hamburger menu, as sidebar is always visible */
            }
        }

        /* For smaller tablets and large phones (portrait) */
        @media (max-width: 768px) {
            body { padding: 0; }
            .app-container { box-shadow: none; }
            #menuToggleBtn { display: block; } /* Show hamburger menu again */
            
            .sidebar {
                position: absolute;
                top: 0;
                right: -320px; /* Start off-screen */
                height: 100%;
                width: 320px;
                max-height: 100%;
                border-bottom: none;
                border-left: 1px solid var(--border-color); /* Re-add border for sliding panel */
                box-shadow: -5px 0 15px var(--shadow-color);
                z-index: 200;
            }
            .sidebar.open {
                transform: translateX(-320px); /* Slide in from the right */
            }
            .header { padding: 12px 15px; }
            .header-content h1 { font-size: 1.2em; }
            .messages { padding: 15px 10px; }
            .input-area { padding: 10px; }
            #recordBtn, #sendBtn { width: 44px; height: 44px; font-size: 1.1rem; }
            #messageInput { padding: 10px 15px; min-height: 44px; font-size: 1rem; }
        }

        /* For mobile phones */
        @media (max-width: 480px) {
            html { font-size: 15px; }
            .sidebar {
                width: 280px;
                right: -280px;
            }
            .sidebar.open {
                transform: translateX(-280px);
            }
            .header-content h1 { font-size: 1.1em; }
            .input-area { gap: 8px; }
            #scrollToBottomBtn { bottom: 15px; right: 15px; width: 40px; height: 40px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="mobile-overlay" id="mobileOverlay"></div>

        <div class="custom-modal-container" id="customModalContainer">
            <div class="custom-modal-content">
                <p id="modalMessageText"></p>
                <div class="custom-modal-buttons">
                    <button id="cancelModalBtn"></button>
                    <button id="confirmModalBtn"></button>
                </div>
            </div>
        </div>

        <div class="modal-container" id="settingsModalContainer">
            <div class="modal-content">
                <button class="modal-close-btn" id="closeSettingsModalBtn" aria-label="Close settings">&times;</button>
                <h2><i class="fas fa-cog"></i> الإعدادات</h2>
                <div class="setting-item">
                    <label for="themeToggleBtn">الوضع الداكن:</label>
                    <button id="themeToggleBtn" aria-label="Toggle theme"><i class="fas fa-moon"></i></button>
                </div>
                <div class="setting-item">
                    <label>حجم خط الرسائل:</label>
                    <div>
                        <button id="decreaseFontBtn" aria-label="Decrease font size">-</button>
                        <span id="currentFontSizePreview">عادي</span>
                        <button id="increaseFontBtn" aria-label="Increase font size">+</button>
                    </div>
                </div>
                 <div class="setting-item">
                    <button id="requestNotificationPermissionBtn" class="full-width-btn">تفعيل إشعارات المتصفح</button>
                </div>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-comments"></i> محادثاتي</h2>
                <p>كل دردشاتك هنا</p>
                <div class="islamic-reminder" id="islamicReminder"></div>
            </div>
            <button id="newChatBtn"><i class="fas fa-plus-circle"></i> محادثة جديدة</button>
            <div class="chat-list" id="chatList"></div>
            <button id="openSettingsBtn" class="sidebar-footer-btn"><i class="fas fa-cog"></i> الإعدادات</button>
        </div>

        <div class="chat-area">
            <div class="header">
                <button id="menuToggleBtn"><i class="fas fa-bars"></i></button>
                <div class="header-content">
                    <h1 id="mainAppTitle"><i class="fas fa-mosque"></i> IslamGPT</h1>
                    <p id="chatSpecificTitle">مساعدك الإسلامي الذكي</p>
                </div>
                <div class="header-actions">
                    <button id="searchChatToggleBtn" aria-label="Search chat" title="بحث في المحادثة"><i class="fas fa-search"></i></button>
                    <div class="chat-options-dropdown">
                        <button id="chatOptionsBtn" aria-label="Chat options" title="خيارات المحادثة"><i class="fas fa-ellipsis-v"></i></button>
                        <div class="dropdown-content" id="chatOptionsDropdownContent">
                            <button id="clearChatBtn"><i class="fas fa-eraser"></i> مسح المحادثة الحالية</button>
                            <button id="exportChatBtn"><i class="fas fa-file-export"></i> تصدير المحادثة</button>
                        </div>
                    </div>
                </div>
                <div id="botStatus">جاري الكتابة...</div>
            </div>
            <div class="search-bar-container" id="searchBarContainer">
                <input type="text" id="chatSearchInput" placeholder="ابحث في هذه المحادثة...">
                <button id="clearSearchBtn" aria-label="Clear search" title="مسح البحث">&times;</button>
            </div>
            <div class="messages" id="messages"></div>
            <button id="scrollToBottomBtn" title="النزول للأسفل"><i class="fas fa-arrow-down"></i></button>
            <div class="input-area" id="inputArea">
                 <div class="recording-indicator" id="recordingIndicator">
                    <i class="fas fa-microphone-alt"></i> جاري التسجيل... <span id="recordingTimer">00:00</span>
                </div>
                <div class="input-area-buttons">
                    <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
                    <button id="recordBtn"><i class="fas fa-microphone"></i></button>
                </div>
                <textarea id="messageInput" placeholder="اكتب سؤالك هنا..." onkeypress="handleEnter(event)" oninput="adjustTextareaHeight()"></textarea>
            </div>
        </div>
        <div class="visually-hidden" id="ariaLiveRegion" aria-live="polite" aria-atomic="true"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js"></script>
    <script>
        // --- CONSTANTS & STATE ---
        const webhookUrl = 'https://n8n-wf0f.onrender.com/webhook/97f43b05-efdc-4ee8-929e-34752486d9d0';
        const ttsWebhookUrl = 'https://n8n-wf0f.onrender.com/webhook/ba9e2b8f-5503-49da-bc1e-7c78c2e5f8f7'; // Placeholder: Change to your actual TTS webhook URL

        let isLoading = false;
        let state = { chats: [], activeChatId: null, currentSearchTerm: '' };

        // Audio/Media State
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recordingInterval;
        let activeAudioElement = null;
        let confirmCallback = null;

        // --- DOM ELEMENTS ---
        const DOM = {
            sidebar: document.getElementById('sidebar'),
            menuToggleBtn: document.getElementById('menuToggleBtn'),
            mobileOverlay: document.getElementById('mobileOverlay'),
            messagesDiv: document.getElementById('messages'),
            messageInput: document.getElementById('messageInput'),
            sendBtn: document.getElementById('sendBtn'),
            chatList: document.getElementById('chatList'),
            newChatBtn: document.getElementById('newChatBtn'),
            mainAppTitle: document.getElementById('mainAppTitle'),
            chatSpecificTitle: document.getElementById('chatSpecificTitle'),
            scrollToBottomBtn: document.getElementById('scrollToBottomBtn'),
            botStatus: document.getElementById('botStatus'),
            settingsModalContainer: document.getElementById('settingsModalContainer'),
            closeSettingsModalBtn: document.getElementById('closeSettingsModalBtn'),
            openSettingsBtn: document.getElementById('openSettingsBtn'),
            themeToggleBtn: document.getElementById('themeToggleBtn'),
            decreaseFontBtn: document.getElementById('decreaseFontBtn'),
            increaseFontBtn: document.getElementById('increaseFontBtn'),
            currentFontSizePreview: document.getElementById('currentFontSizePreview'),
            islamicReminder: document.getElementById('islamicReminder'),
            searchChatToggleBtn: document.getElementById('searchChatToggleBtn'),
            searchBarContainer: document.getElementById('searchBarContainer'),
            chatSearchInput: document.getElementById('chatSearchInput'),
            clearSearchBtn: document.getElementById('clearSearchBtn'),
            chatOptionsBtn: document.getElementById('chatOptionsBtn'),
            chatOptionsDropdownContent: document.getElementById('chatOptionsDropdownContent'),
            clearChatBtn: document.getElementById('clearChatBtn'),
            exportChatBtn: document.getElementById('exportChatBtn'),
            ariaLiveRegion: document.getElementById('ariaLiveRegion'),
            requestNotificationPermissionBtn: document.getElementById('requestNotificationPermissionBtn'),
            // New & Integrated Elements
            inputArea: document.getElementById('inputArea'),
            recordBtn: document.getElementById('recordBtn'),
            recordingIndicator: document.getElementById('recordingIndicator'),
            recordingTimer: document.getElementById('recordingTimer'),
            customModalContainer: document.getElementById('customModalContainer'),
            modalMessageText: document.getElementById('modalMessageText'),
            confirmModalBtn: document.getElementById('confirmModalBtn'),
            cancelModalBtn: document.getElementById('cancelModalBtn'),
        };

        // --- CUSTOM MODAL ---
        function showConfirmModal(message, confirmText, cancelText, onConfirm) {
            DOM.modalMessageText.textContent = message;
            DOM.confirmModalBtn.textContent = confirmText;
            DOM.cancelModalBtn.textContent = cancelText;
            DOM.customModalContainer.classList.add('visible');
            confirmCallback = onConfirm;
        }

        function hideConfirmModal() {
            DOM.customModalContainer.classList.remove('visible');
            confirmCallback = null;
        }

        // --- THEME & FONT SETTINGS ---
        let currentTheme = localStorage.getItem('islamGptTheme') || 'dark';
        const fontSizeSteps = [-0.2, -0.1, 0, 0.1, 0.2, 0.3];
        let currentFontSizeStep = parseInt(localStorage.getItem('islamGptFontSizeStep') || '2');

        function applyTheme(theme) {
            if (theme === 'light') {
                document.documentElement.classList.add('light-theme');
                DOM.themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.documentElement.classList.remove('light-theme');
                DOM.themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
            }
            currentTheme = theme;
            localStorage.setItem('islamGptTheme', theme);
        }
        function toggleTheme() { applyTheme(currentTheme === 'dark' ? 'light' : 'dark'); }

        function applyFontSize() {
            const baseMobileSize = window.matchMedia("(max-width: 480px)").matches ? 0.85 : window.matchMedia("(max-width: 768px)").matches ? 0.9 : 0.95;
            const newSize = baseMobileSize + fontSizeSteps[currentFontSizeStep];
            document.documentElement.style.setProperty('--message-font-base-size', `${newSize}rem`);
            const previewTexts = ["صغير جداً", "صغير", "عادي", "كبير", "كبير جداً", "الأكبر"];
            DOM.currentFontSizePreview.textContent = previewTexts[currentFontSizeStep];
            localStorage.setItem('islamGptFontSizeStep', currentFontSizeStep);
        }
        function changeFontSize(direction) {
            if (direction === 'increase' && currentFontSizeStep < fontSizeSteps.length - 1) currentFontSizeStep++;
            else if (direction === 'decrease' && currentFontSizeStep > 0) currentFontSizeStep--;
            applyFontSize();
        }

        // --- AUDIO & MEDIA ---
        function stopActiveAudio() {
            if (activeAudioElement && !activeAudioElement.paused) {
                activeAudioElement.pause();
                activeAudioElement.currentTime = 0;
                 if (activeAudioElement.ttsButton) {
                    activeAudioElement.ttsButton.classList.remove('playing');
                    activeAudioElement.ttsButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                }
            }
            activeAudioElement = null;
        }

        async function playTTS(text, buttonElement) {
            if (buttonElement.classList.contains('loading') || buttonElement.classList.contains('playing')) {
                 stopActiveAudio();
                 return;
            }
            stopActiveAudio(); // Stop any other audio

            buttonElement.classList.add('loading');
            buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(ttsWebhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });

                if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                
                const audioBlob = await response.blob();
                if (!audioBlob.type.startsWith('audio/')) throw new Error("Response is not a valid audio file.");

                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.ttsButton = buttonElement; // Link button to audio
                activeAudioElement = audio;
                
                buttonElement.classList.remove('loading');
                buttonElement.classList.add('playing');
                buttonElement.innerHTML = '<i class="fas fa-wave-square"></i>';
                
                audio.play();
                audio.onended = () => {
                    buttonElement.classList.remove('playing');
                    buttonElement.innerHTML = '<i class="fas fa-volume-up"></i>';
                    URL.revokeObjectURL(audioUrl);
                    if(activeAudioElement === audio) activeAudioElement = null;
                };

            } catch (error) {
                console.error("TTS Error:", error);
                alert("عذراً، حدث خطأ أثناء تحويل النص إلى كلام. تأكد من أن رابط الـ TTS صحيح.");
                buttonElement.classList.remove('loading');
                buttonElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                setTimeout(() => buttonElement.innerHTML = '<i class="fas fa-volume-up"></i>', 2000);
            }
        }

        async function toggleRecording() {
            if (isRecording) {
                mediaRecorder.stop();
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    isRecording = true;
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        isRecording = false;
                        clearInterval(recordingInterval);
                        DOM.inputArea.classList.remove('recording-active');
                        DOM.recordBtn.classList.remove('recording');
                        DOM.recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                        DOM.messageInput.disabled = false;
                        DOM.sendBtn.disabled = false;
                        stream.getTracks().forEach(track => track.stop()); // Release microphone
                        sendAudioMessage();
                    };
                    
                    mediaRecorder.start();
                    
                    DOM.inputArea.classList.add('recording-active');
                    DOM.recordBtn.classList.add('recording');
                    DOM.recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
                    DOM.messageInput.value = '';
                    DOM.messageInput.disabled = true;
                    DOM.sendBtn.disabled = true;
                    let startTime = Date.now();
                    DOM.recordingTimer.textContent = '00:00';
                    recordingInterval = setInterval(() => {
                        const seconds = Math.floor((Date.now() - startTime) / 1000);
                        const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
                        const secs = String(seconds % 60).padStart(2, '0');
                        DOM.recordingTimer.textContent = `${mins}:${secs}`;
                    }, 1000);

                } catch (err) {
                    console.error("Microphone access denied:", err);
                    alert("تحتاج للسماح بالوصول إلى الميكروفون لتسجيل رسالة صوتية.");
                }
            }
        }

        async function sendAudioMessage() {
            if (audioChunks.length === 0) return;
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const audioUrl = URL.createObjectURL(audioBlob);

            if (state.activeChatId && state.chats.find(c => c.id === state.activeChatId).messages.length === 0) {
                DOM.messagesDiv.innerHTML = ''; // Clear welcome message
            }

            const userMsg = addMessageToState('', true, false, 'audio', audioUrl);
            if(userMsg) displayMessage(userMsg, true);
            autoScrollToBottom(true);
            
            isLoading = true;
            setLoadingState(true);
            showLoadingIndicator();

            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.webm');
            formData.append('source', 'IslamGPT_Audio_v2');
            formData.append('chat_id', state.activeChatId);
            
            try {
                const response = await fetch(webhookUrl, { method: 'POST', body: formData });
                hideLoadingIndicator();
                if (!response.ok) { let errBody="فشل"; try{errBody=await response.text();}catch(_){} throw new Error(`خطأ ${response.status}: ${errBody||response.statusText}`); }
                
                const data = await response.json();
                const botResponseText = data.response || data.message || "تم استلام الصوت، لكن لا يوجد رد نصي.";
                const botMsg = addMessageToState(botResponseText, false);
                if (botMsg) streamBotMessage(botMsg);

            } catch (error) {
                handleApiError(error);
            } finally {
                isLoading = false;
                setLoadingState(false);
            }
        }

        // --- MESSAGE & STATE LOGIC (MODIFIED) ---
        function addMessageToState(text, isUser, isError = false, type = 'text', data = null) {
            const activeChat = state.chats.find(chat => chat.id === state.activeChatId);
            if (!activeChat) return null;
            
            const message = {
                id: generateId(), type: type, text: text,
                isUser: isUser, isError: isError, timestamp: new Date().toISOString(),
                isPinned: false, data: data // For audio, this holds the local blob URL
            };
            activeChat.messages.push(message);

            if (isUser && type === 'text' && activeChat.messages.filter(m => m.isUser && m.type === 'text').length === 1 && activeChat.name.startsWith("محادثة ")) {
                const firstWords = String(text).split(' ').slice(0, 4).join(' ');
                activeChat.name = firstWords.substring(0,30) + (String(text).length > 30 ? "..." : "");
                renderChatList(); updateChatTitle();
            }
            saveState(); return message; 
        }

        function displayMessage(message, animateAsNew = false) {
            const { id, type, text, isUser, isError, timestamp, isPinned, data } = message;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.id = `msg-${id}`;
            if(animateAsNew) messageDiv.classList.add('animate-new');
            if (isError) messageDiv.classList.add('error');

            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'message-actions';
            
            if (!isUser && type === 'text') {
                const ttsBtn = document.createElement('button');
                ttsBtn.className = 'tts-message-btn'; ttsBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                ttsBtn.title = "استمع للرسالة";
                ttsBtn.onclick = (e) => {
                    const currentText = document.querySelector(`#msg-${id} .message-content`).innerText;
                    playTTS(currentText, e.currentTarget);
                };
                actionsContainer.appendChild(ttsBtn);
            }

            if (type === 'text') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-message-btn'; copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                copyBtn.title = "نسخ النص";
                copyBtn.onclick = () => {
                    const currentText = document.querySelector(`#msg-${id} .message-content`).innerText;
                    copyToClipboard(currentText);
                };
                actionsContainer.appendChild(copyBtn);
            }
            
            const pinBtn = document.createElement('button');
            pinBtn.className = `pin-message-btn ${isPinned ? 'pinned' : ''}`;
            pinBtn.innerHTML = `<i class="fas fa-thumbtack"></i>`;
            pinBtn.title = isPinned ? "إلغاء تثبيت" : "تثبيت";
            pinBtn.setAttribute('aria-pressed', isPinned);
            pinBtn.onclick = () => togglePinMessage(id);
            actionsContainer.appendChild(pinBtn);
            
            messageDiv.appendChild(actionsContainer);

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (type === 'audio') {
                const audioPlayer = document.createElement('audio');
                audioPlayer.controls = true;
                audioPlayer.src = data; // Blob URL
                audioPlayer.onplay = () => {
                    stopActiveAudio();
                    activeAudioElement = audioPlayer;
                };
                contentDiv.appendChild(audioPlayer);
            } else {
                let sanitizedText = DOMPurify.sanitize(String(text).replace(/\n/g, '<br>'));
                if (state.currentSearchTerm && sanitizedText.toLowerCase().includes(state.currentSearchTerm)) {
                    const regex = new RegExp(state.currentSearchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').split(/\s+/).filter(Boolean).join('|'), 'gi');
                    sanitizedText = sanitizedText.replace(regex, match => `<mark>${match}</mark>`);
                }
                contentDiv.innerHTML = sanitizedText;
            }
            messageDiv.appendChild(contentDiv);

            const timestampDiv = document.createElement('div');
            timestampDiv.className = 'message-timestamp';
            try { timestampDiv.textContent = formatMessageTimestamp(timestamp); }
            catch (e) { timestampDiv.textContent = "---"; }
            messageDiv.appendChild(timestampDiv);
            
            DOM.messagesDiv.appendChild(messageDiv);
        }

        function streamBotMessage(messageObject) {
            const { id, text } = messageObject;
            // Create a placeholder message
            displayMessage({ ...messageObject, text: '' }, true);
            autoScrollToBottom(true);
            const messageContentEl = document.querySelector(`#msg-${id} .message-content`);
            if (!messageContentEl) return;
            
            let sanitizedText = DOMPurify.sanitize(String(text).replace(/\n/g, '<br>'));
            const words = sanitizedText.split(' ');
            let i = 0;
            const interval = setInterval(() => {
                if (i < words.length) {
                    messageContentEl.innerHTML += words[i] + ' ';
                    autoScrollToBottom();
                    i++;
                } else {
                    clearInterval(interval);
                    // Final state update is already done when message was added
                }
            }, 60);
        }

        // --- SEND MESSAGE & API (MODIFIED) ---
        async function sendMessage() {
            const messageText = DOM.messageInput.value.trim();
            if (!messageText || isLoading || !state.activeChatId) return;

            const activeChat = state.chats.find(chat => chat.id === state.activeChatId);
            if (!activeChat) return;
            if (activeChat.messages.length === 0) DOM.messagesDiv.innerHTML = '';
            
            const userMsg = addMessageToState(messageText, true);
            if(userMsg) displayMessage(userMsg, true);
            autoScrollToBottom(true);
            DOM.messageInput.value = ''; adjustTextareaHeight();
            
            isLoading = true;
            setLoadingState(true);
            showLoadingIndicator();
            
            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST', headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
                    body: JSON.stringify({ message: messageText, chat_id: state.activeChatId })
                });
                hideLoadingIndicator();
                if (!response.ok) { let errBody="فشل"; try{errBody=await response.text();}catch(_){} throw new Error(`خطأ ${response.status}: ${errBody||response.statusText}`); }

                const data = await response.json();
                const botResponseText = data.response || data.message || "رد غير متوقع.";

                const botMsg = addMessageToState(botResponseText, false);
                if (botMsg) streamBotMessage(botMsg);

            } catch (error) {
                handleApiError(error);
            } finally {
                isLoading = false;
                setLoadingState(false);
            }
        }
        
        function handleApiError(error) {
            hideLoadingIndicator(); console.error('API Error:', error);
            let errMsg = 'عذراً، حدث خطأ: ';
            errMsg += (error.name === 'TypeError' && error.message.includes('Failed to fetch')) ? 'تعذر الاتصال بالخادم.' : error.message;
            const errBotMsg = addMessageToState(errMsg, false, true);
            if(errBotMsg) displayMessage(errBotMsg, true);
            announceToScreenReader(errMsg); autoScrollToBottom();
        }
        
        // --- UI & RENDER FUNCTIONS (MANY ORIGINAL FUNCTIONS ARE HERE) ---
        function setLoadingState(loading) {
            const canInteract = !loading && !!state.activeChatId;
            DOM.sendBtn.disabled = !canInteract || !DOM.messageInput.value.trim();
            DOM.recordBtn.disabled = !canInteract;
            DOM.messageInput.disabled = !canInteract;
            
            if (loading) {
                 DOM.sendBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            } else {
                 DOM.sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                 if (canInteract) DOM.messageInput.focus();
            }
        }

        let userScrolledUp = false;
        function handleScroll() {
            const { scrollTop, scrollHeight, clientHeight } = DOM.messagesDiv;
            userScrolledUp = scrollHeight - scrollTop - clientHeight > clientHeight * 0.5;
            DOM.scrollToBottomBtn.classList.toggle('visible', userScrolledUp);
        }
        function autoScrollToBottom(force = false) {
            if (!userScrolledUp || force) {
                DOM.messagesDiv.scrollTop = DOM.messagesDiv.scrollHeight;
            }
        }
        function adjustTextareaHeight() {
            DOM.messageInput.style.height = 'auto';
            const scrollHeight = DOM.messageInput.scrollHeight;
            const maxHeight = parseInt(window.getComputedStyle(DOM.messageInput).maxHeight, 10);
            DOM.messageInput.style.height = Math.min(scrollHeight, maxHeight) + 'px';
            DOM.sendBtn.disabled = isLoading || !DOM.messageInput.value.trim();
        }

        function renderMessages() {
            DOM.messagesDiv.innerHTML = '';
            const activeChat = state.chats.find(chat => chat.id === state.activeChatId);
            if (!activeChat) {
                DOM.messagesDiv.innerHTML = `<div class="no-chat-selected"><i class="fas fa-comments"></i><h3>لم يتم تحديد محادثة</h3><p>اختر محادثة أو أنشئ واحدة جديدة.</p></div>`;
                return;
            }
            if (activeChat.messages.length === 0) {
                DOM.messagesDiv.innerHTML = `<div class="welcome-area"><i class="fas fa-hand-sparkles"></i><h3>أهلاً بك في ${DOMPurify.sanitize(activeChat.name)}</h3><p>اطرح سؤالك في الأسفل أو اختر من الاقتراحات السريعة:</p><div class="quick-prompts-container" id="quickPromptsContainer"></div></div>`;
                populateQuickPrompts();
            } else {
                const pinnedMessages = activeChat.messages.filter(msg => msg.isPinned);
                const regularMessages = activeChat.messages.filter(msg => !msg.isPinned);

                pinnedMessages.forEach(msg => displayMessage(msg));
                if(pinnedMessages.length > 0 && regularMessages.length > 0) {
                    const separator = document.createElement('hr'); 
                    separator.style.borderColor = 'var(--border-color)';
                    separator.style.margin = '10px 0';
                    DOM.messagesDiv.appendChild(separator);
                }
                regularMessages.forEach(msg => displayMessage(msg));
            }
            autoScrollToBottom(true);
        }

        function deleteChat(chatId, event) {
            event.stopPropagation();
            showConfirmModal(
                "هل أنت متأكد أنك تريد حذف هذه المحادثة؟ لا يمكن التراجع عن هذا الإجراء.",
                "نعم, احذف",
                "إلغاء",
                () => {
                    state.chats = state.chats.filter(chat => chat.id !== chatId);
                    if (state.activeChatId === chatId) {
                        state.activeChatId = state.chats.length > 0 ? state.chats[0].id : null;
                    }
                    saveState();
                    renderApp();
                    hideConfirmModal();
                }
            );
        }

        // --- ALL OTHER ORIGINAL FUNCTIONS ---
        // (Copied and verified for completeness)
        function generateId() { return '_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36); }
        function saveState() { try { localStorage.setItem('islamGptState', JSON.stringify(state)); } catch (e) { console.error("Save state failed:", e); }}
        function loadState() {
            try {
                const storedState = localStorage.getItem('islamGptState');
                if (storedState) {
                    const parsedState = JSON.parse(storedState);
                    state = { ...state, ...parsedState };
                    if (!Array.isArray(state.chats)) state.chats = [];
                    state.chats.forEach(chat => {
                        if (!Array.isArray(chat.messages)) chat.messages = [];
                        chat.messages.forEach(msg => {
                            if (!msg.id) msg.id = generateId();
                            if (msg.isPinned === undefined) msg.isPinned = false;
                            if (!msg.type) msg.type = 'text';
                            if (msg.type === 'audio') msg.data = null; // Don't persist blob URLs
                        });
                    });
                    if (state.activeChatId && !state.chats.find(c => c.id === state.activeChatId)) state.activeChatId = null;
                }
            } catch (e) { console.error("Load state failed:", e); state.chats = []; }
        }
        function openSettingsModal() { DOM.settingsModalContainer.classList.add('visible'); }
        function closeSettingsModal() { DOM.settingsModalContainer.classList.remove('visible'); }
        function toggleMobileMenu() {
            DOM.sidebar.classList.toggle('open');
            DOM.mobileOverlay.classList.toggle('active');
        }
        function toggleChatOptionsDropdown(event) {
            event.stopPropagation();
            DOM.chatOptionsDropdownContent.parentElement.classList.toggle('open');
        }
        const islamicReminders = ["سبحان الله وبحمده، سبحان الله العظيم.", "استغفر الله العظيم وأتوب إليه.", "لا إله إلا أنت سبحانك إني كنت من الظالمين.", "اللهم صل وسلم على نبينا محمد."];
        function displayIslamicReminder() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            DOM.islamicReminder.textContent = islamicReminders[dayOfYear % islamicReminders.length];
        }
        function announceToScreenReader(text) { DOM.ariaLiveRegion.textContent = text; setTimeout(() => { DOM.ariaLiveRegion.textContent = ''; }, 500); }
        function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => { announceToScreenReader("تم نسخ النص"); }).catch(err => { console.error('Failed to copy: ', err); alert("فشل النسخ."); }); }
        function createNewChat(switchToNew = true) {
            const newChatId = generateId();
            const newChat = { id: newChatId, name: `محادثة ${state.chats.length + 1}`, messages: [], createdAt: new Date().toISOString() };
            state.chats.unshift(newChat);
            if (switchToNew || !state.activeChatId) state.activeChatId = newChatId;
            saveState(); renderApp();
            if (switchToNew) DOM.messageInput.focus();
            if (DOM.sidebar.classList.contains('open')) toggleMobileMenu();
        }
        function switchChat(chatId) {
            if (state.activeChatId === chatId) { if (DOM.sidebar.classList.contains('open')) toggleMobileMenu(); return; }
            state.activeChatId = chatId; 
            state.currentSearchTerm = '';
            DOM.chatSearchInput.value = '';
            DOM.searchBarContainer.classList.remove('visible');
            saveState(); renderApp();
            DOM.messageInput.focus();
            if (DOM.sidebar.classList.contains('open')) toggleMobileMenu();
        }
        function renameChat(chatId, listItemElement) {
            const chat = state.chats.find(c => c.id === chatId);
            if (!chat) return;
            listItemElement.classList.add('renaming');
            const newName = prompt("أدخل الاسم الجديد للمحادثة:", chat.name);
            listItemElement.classList.remove('renaming');
            if (newName && newName.trim() && newName.trim() !== chat.name) {
                chat.name = newName.trim().substring(0, 50);
                saveState(); renderApp();
            }
        }
        function clearCurrentChat() {
            if (!state.activeChatId) return;
            showConfirmModal("هل أنت متأكد أنك تريد مسح جميع الرسائل في هذه المحادثة؟", "نعم، امسح", "إلغاء", () => {
                const activeChat = state.chats.find(chat => chat.id === state.activeChatId);
                if (activeChat) { activeChat.messages = []; saveState(); renderMessages(); }
                hideConfirmModal();
            });
            if (DOM.chatOptionsDropdownContent) DOM.chatOptionsDropdownContent.parentElement.classList.remove('open');
        }
        function exportChat() {
            if (!state.activeChatId) return;
            const activeChat = state.chats.find(chat => chat.id === state.activeChatId);
            if (activeChat && activeChat.messages.length > 0) {
                let chatText = `محادثة: ${activeChat.name}\nتاريخ التصدير: ${new Date().toLocaleString('ar-EG')}\n\n`;
                activeChat.messages.forEach(msg => {
                    const prefix = msg.isUser ? "أنت:" : "IslamGPT:";
                    const time = formatMessageTimestamp(msg.timestamp);
                    const content = msg.type === 'audio' ? "[رسالة صوتية]" : msg.text;
                    chatText += `[${time}] ${prefix}\n${content}\n\n`;
                });
                const blob = new Blob([chatText], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${activeChat.name.replace(/[^a-z0-9إلىيء-ي]/gi, '_')}.txt`;
                link.click(); URL.revokeObjectURL(link.href);
            } else { alert("لا توجد رسائل لتصديرها."); }
            if (DOM.chatOptionsDropdownContent) DOM.chatOptionsDropdownContent.parentElement.classList.remove('open');
        }
        function toggleSearchChat() { DOM.searchBarContainer.classList.toggle('visible'); if (DOM.searchBarContainer.classList.contains('visible')) { DOM.chatSearchInput.focus(); } else { DOM.chatSearchInput.value = ''; state.currentSearchTerm = ''; renderMessages(); } }
        function handleChatSearch() { state.currentSearchTerm = DOM.chatSearchInput.value.trim().toLowerCase(); renderMessages(); }
        function clearChatSearch() { DOM.chatSearchInput.value = ''; state.currentSearchTerm = ''; renderMessages(); DOM.chatSearchInput.focus(); }
        function togglePinMessage(messageId) {
            if (!state.activeChatId) return;
            const activeChat = state.chats.find(chat => chat.id === state.activeChatId);
            if (activeChat) {
                const message = activeChat.messages.find(msg => msg.id === messageId);
                if (message) { message.isPinned = !message.isPinned; saveState(); renderMessages(); }
            }
        }
        const quickPrompts = [ { display: "ما هي أركان الإسلام؟", prompt: "ما هي أركان الإسلام الخمسة؟" }, { display: "شرح سورة الفاتحة", prompt: "اشرح لي معاني سورة الفاتحة." }, { display: "قصة النبي آدم", prompt: "حدثني عن قصة النبي آدم عليه السلام." }];
        function populateQuickPrompts() {
            const container = document.getElementById('quickPromptsContainer');
            if (!container) return;
            container.innerHTML = '<h4><i class="fas fa-lightbulb"></i> اقتراحات سريعة:</h4>';
            quickPrompts.forEach(qp => {
                const btn = document.createElement('button'); btn.className = 'quick-prompt-btn'; btn.textContent = qp.display;
                btn.onclick = () => { DOM.messageInput.value = qp.prompt; sendMessage(); }; container.appendChild(btn);
            });
        }
        function formatMessageTimestamp(isoTimestamp) {
            const date = new Date(isoTimestamp); const now = new Date();
            const diffSeconds = Math.round((now - date) / 1000); const diffMinutes = Math.round(diffSeconds / 60); const diffHours = Math.round(diffMinutes / 60);
            if (diffSeconds < 5) return "الآن"; if (diffSeconds < 60) return `منذ ${diffSeconds} ثانية`; if (diffMinutes < 60) return `منذ ${diffMinutes} دقيقة`;
            if (diffHours < 24 && date.getDate() === now.getDate()) return `اليوم ${date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}`;
            if (diffHours < 48 && date.getDate() === now.getDate() - 1) return `أمس ${date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}`;
            return date.toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' }) + ' ' + date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        }
        function updateChatTitle() {
            const activeChat = state.chats.find(chat => chat.id === state.activeChatId);
            DOM.mainAppTitle.innerHTML = `<i class="fas fa-mosque"></i> IslamGPT`;
            DOM.chatSpecificTitle.textContent = activeChat ? activeChat.name : "مساعدك الإسلامي الذكي";
        }
        function renderChatList() {
            DOM.chatList.innerHTML = '';
            if (state.chats.length === 0) { DOM.chatList.innerHTML = '<p class="info-message" style="padding: 20px 10px;">لا توجد محادثات بعد.</p>'; return; }
            state.chats.forEach(chat => {
                const item = document.createElement('div');
                item.className = `chat-list-item ${chat.id === state.activeChatId ? 'active' : ''}`;
                item.setAttribute('data-id', chat.id); item.onclick = () => switchChat(chat.id);
                item.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') switchChat(chat.id); };
                const chatNameSpan = document.createElement('span'); chatNameSpan.textContent = chat.name; chatNameSpan.title = chat.name;
                chatNameSpan.ondblclick = (e) => { e.stopPropagation(); renameChat(chat.id, item); };
                const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-chat-btn'; deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.title = "حذف المحادثة"; deleteBtn.onclick = (e) => deleteChat(chat.id, e);
                item.appendChild(deleteBtn); item.appendChild(chatNameSpan); DOM.chatList.appendChild(item);
            });
        }
        function renderApp() { renderChatList(); renderMessages(); updateChatTitle(); adjustTextareaHeight(); setLoadingState(isLoading); }
        function showLoadingIndicator() {
            if (document.getElementById('loadingIndicator')) return;
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message bot-message loading animate-new'; loadingDiv.id = 'loadingIndicator';
            loadingDiv.style.opacity = '1';
            loadingDiv.innerHTML = `<div class="message-content">جاري الكتابة... <i class="fas fa-spinner fa-spin"></i></div><div class="message-timestamp">&nbsp;</div>`;
            DOM.messagesDiv.appendChild(loadingDiv);
            DOM.botStatus.classList.add('visible'); autoScrollToBottom(true);
        }
        function hideLoadingIndicator() { const loading = document.getElementById('loadingIndicator'); if (loading) loading.remove(); DOM.botStatus.classList.remove('visible'); }
        function handleEnter(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } }
        async function registerServiceWorkerAndSubscribe() { alert("ميزة الإشعارات تتطلب إعدادات متقدمة من جانب الخادم."); }

        // --- INITIALIZATION ---
        function init() {
            loadState();
            applyTheme(currentTheme);
            applyFontSize();
            displayIslamicReminder();
            
            if (state.chats.length === 0) createNewChat(false);
            else if (!state.activeChatId || !state.chats.find(c => c.id === state.activeChatId)) {
                state.activeChatId = state.chats[0].id;
            }
            renderApp();
            
            // Event Listeners
            DOM.newChatBtn.onclick = () => createNewChat(true);
            DOM.menuToggleBtn.onclick = toggleMobileMenu;
            DOM.mobileOverlay.onclick = toggleMobileMenu;
            DOM.messagesDiv.addEventListener('scroll', handleScroll);
            DOM.scrollToBottomBtn.onclick = () => autoScrollToBottom(true);
            DOM.openSettingsBtn.onclick = openSettingsModal;
            DOM.closeSettingsModalBtn.onclick = closeSettingsModal;
            DOM.themeToggleBtn.onclick = toggleTheme;
            DOM.increaseFontBtn.onclick = () => changeFontSize('increase');
            DOM.decreaseFontBtn.onclick = () => changeFontSize('decrease');
            DOM.searchChatToggleBtn.onclick = toggleSearchChat;
            DOM.chatSearchInput.addEventListener('input', handleChatSearch);
            DOM.clearSearchBtn.onclick = clearChatSearch;
            DOM.chatOptionsBtn.onclick = toggleChatOptionsDropdown;
            DOM.clearChatBtn.onclick = clearCurrentChat;
            DOM.exportChatBtn.onclick = exportChat;
            DOM.requestNotificationPermissionBtn.onclick = registerServiceWorkerAndSubscribe;
            DOM.recordBtn.onclick = toggleRecording;
            DOM.sendBtn.onclick = sendMessage;
            DOM.messageInput.addEventListener('input', adjustTextareaHeight);
            DOM.messageInput.addEventListener('keypress', handleEnter);
            DOM.confirmModalBtn.onclick = () => { if(confirmCallback) confirmCallback(); };
            DOM.cancelModalBtn.onclick = hideConfirmModal;
            DOM.customModalContainer.onclick = (e) => { if(e.target === DOM.customModalContainer) hideConfirmModal(); };
            document.addEventListener('click', (event) => { if (DOM.chatOptionsDropdownContent.parentElement.classList.contains('open') && !DOM.chatOptionsDropdownContent.parentElement.contains(event.target)) { DOM.chatOptionsDropdownContent.parentElement.classList.remove('open'); } });
        }
        
        if (typeof DOMPurify === 'undefined') {
            console.warn("DOMPurify not loaded. HTML will not be sanitized.");
            window.DOMPurify = { sanitize: (text) => String(text).replace(/</g, "&lt;").replace(/>/g, "&gt;") };
        }
        window.onload = init;
    </script>
</body>
</html>
